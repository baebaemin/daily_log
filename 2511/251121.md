## Today I Learned

### [TIL-WORDS]

- 경쟁 상태 [Race Condition](https://en.wikipedia.org/wiki/Race_condition): 둘 이상의 입력 또는 조작의 타이밍이나 순서 등이 결과값에 영향을 줄 수 있는 상태. 여러 개의 프로세스가 동시에 접근을 시도할 때 정상적인 결과가 나오지 않게 될 위험이 있는데 이를 경쟁 위험이라고 한다.

## <br />

### [React] 네비게이션시 zustand와 react query의 상태 관리 차이

- zustand는 클라이언트 전역 state = 컴포넌트 라이프사이클과 독립적임

  - 구독 취소된 컴포넌트들은 무시되기 때문에 안전한 상태변경이 가능하며, 네비게이션 타이밍에 초기화되지 않는다.

- 반면, React Query는 서버/클라이언트에서 사용 가능한 state

  - 컴포넌트 마운트/언마운트에 딸 옵저버가 동작하므로 라이프 사이클과 밀접한 관련이 있다.
  - 비동기 사이드 이펙트가 있는 캐시를 기반으로 상태를 관리함

- 그러므로 zustand는 application 수준의 전역 상태를, React Query는 서버 데이터 캐싱에 적합하다.

> [zustand] 네비게이션 후에도 상태가 유지

```tsx
  const actions = useHiringCreateStore((state) => state.actions);

  // step2로 이동해도 해당 페이지에서 업데이트된 step1Data 접근 가능
  actions.setStep1Data({ ... });
  router.push("/step2");
```

> [React Query] 서버 to 서버 CASE > 각 페이지마다 새로 fetch

```tsx
  // step1/page.tsx
  const data = await queryClient.fetchQuery(...);
  // step2/page.tsx
  const data = await queryClient.fetchQuery(...); // 새 인스턴스 - fetchQUery()는 캐시를 사용하지 않는다
```

> [React Query] 클라이언트 to 클라이언트 CASE > useQuery로 캐시 사용

```tsx
// step1에서 어떤 클라이언트 컴포넌트가 있었고 useQuery로 서버 요청 - 캐시에 저장
const { data } = useQuery({
  ...queries.user,
  staleTime: 60000, // 60초
});

// ... 30초 후 step2로 이동 ...

// step2의 다른 클라이언트 컴포넌트 -> staleTime 내이므로 캐시에서 가져옴
const { data } = useQuery({
  ...queries.user,
  staleTime: 60000,
});
```

> [React Query] 서버 to 클라이언트 CASE

```tsx
// step2/page.tsx - 서버
export default async function Step2() {
  const queryClient = getQueryClient();
  const teamInfo = await queryClient.fetchQuery(queries.getTeamInfo);
  // 항상 서버에서 fetch (캐시 없음)

  return (
    <HydrationBoundary state={dehydrate(queryClient)}>
      <FieldSection teamNo={teamInfo.workTeam.teamNo} />
    </HydrationBoundary>
  );
}

// 만약 FieldSection 내부에서 useQuery를 사용한다면?
// FieldSection.tsx - 클라이언트
export function FieldSection({ teamNo }) {
  // 서버 컴포넌트가 HydrationBoundary로 전달한 데이터가 초기 캐시가 됨 - 캐시 사용
  const { data: teamInfo } = useQuery(queries.getTeamInfo);
}
```
