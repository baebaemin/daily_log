## Today I Learned

### [TIL-WORDS]

- `derived`: 파생된 (ex. derived state)
- `effectively`: 효과적으로, 실제로(= really)
- `pitfall`: 함정

## <br />

### [Debug] hydration mismatch (React Error #418)

- local 개발 환경에서는 발생하지 않았던 에러가 dev, stg 등 prod 환경에 배포된 페이지를 확인하다보니 발생하고 있었다.
- date-fns를 활용해 Date 데이터를 가공하는 로직이 있는 페이지에서 발생하는 것으로 추정
- 서버와 클라이언트의 locale 설정이 다르고(서버는 주로 en-US, 클라이언트는 사용자 브라우저 언어를 따라감), time zone도 다르기 때문에(서버는 UTC 또는 서버 위치, 클라이언트는 사용자의 로컬 time zone을 따라감) 발생

  ```js
  // 서버에서 렌더링: "11/12/2025, 10:00:00 AM"
  // 클라이언트에서 렌더링: "2025. 12. 11. 오전 10:00:00"
  // → HTML 불일치로 hydration error 발생
  ```

- 첫 번째 시도 : "use client"를 hydration error가 발생할만한 자식 컴포넌트들에 붙이기 -> 실패 ...
- 두 번째 시도 : 날짜 관련 데이터를 사용하는 tag에 suppressHydrationWarning 붙이기 -> 실패 ... 2
- 세 번째 시도 : google chrome devtools mcp 서버 연결해서 원인 파악 요청 ^ㅡ^ -> ... 성공

```tsx
// 문제가 됐던 함수 - date fns의 메서드들을 사용 중
/**
 * D-day 계산 (마감일 기준)
 * @param recEndDtm 마감일 문자열 (예: "2025-12-04T19:18:44")
 * @param maxDays 임계값 (예: maxDays가 3일 경우 D-4부터는 null 반환)
 * @returns D-day 문자열 (예: "D-3", "D-0") 또는 마감된 경우 null
 */
export const getDday = ({
  endDate,
  maxDays = Infinity,
}: {
  endDate: string;
  maxDays: number;
}): string | null => {
  const now = TZDate.tz("Asia/Seoul");
  const targetDate = TZDate.tz("Asia/Seoul", endDate);

  // 날짜만 비교하기 위해 자정으로 정규화
  const nowStartOfDay = startOfDay(now);
  const targetStartOfDay = startOfDay(targetDate);
  const diff = differenceInDays(targetStartOfDay, nowStartOfDay);

  // 마감일이 지났거나 임계값 이상이면 null 반환
  if (diff <= 0 || diff > maxDays) {
    return null;
  }

  return `D-${diff === 0 ? "day" : diff}`;
};
```

```tsx
// 문제가 됐던 부분
const dDay = getDday({ endDate: recEndDtm, maxDays: 3 });

return (
  <span>
    {REC_ST_CD_TYPE[recStCd]} {dDay && `(${dDay})`}
  </span>
);
```

```tsx
// 해결 방법
// 클라이언트에서만 D-day 계산 (hydration mismatch 방지)
const [dDay, setDDay] = useState<string | null>(null);

useEffect(() => {
  setDDay(getDday({ endDate: recEndDtm, maxDays: 3 }));
}, [recEndDtm]);
```

- 관련 링크 : https://react.dev/reference/react-dom/client/hydrateRoot#suppressing-unavoidable-hydration-mismatch-errors
