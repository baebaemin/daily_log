## Today I Learned

### [TIL-WORDS]

- `intact`: 손대지 않은

## <br />

### [React Query] structuralSharing

- 리액트 쿼리는 컴포넌트가 필요할 때만 리렌더링 되도록 여러 최적화 기법을 자동으로 적용한다. 그중 하나가 structuralSharing으로, 데이터를 refetch해와도 참조값을 유지할 수 있도록 한다.

- 보통 네트워크로 데이터를 fetching할 때마다 JSON.parse()를 거치면서 완전히 새로운 객체가 생성된다.

  ```js
  // 서버에서 받은 JSON 문자열
  const jsonString = '{"id": 1, "name": "John"}';

  // JSON.parse()는 매번 새로운 객체를 생성
  const obj1 = JSON.parse(jsonString);
  const obj2 = JSON.parse(jsonString);

  // 위의 둘은 메모리상 완전히 다른 위치에 생성됨
  console.log(obj1 === obj2); // false
  ```

- 하지만 React Query는 데이터가 완전히 같으면 original 참조값을 유지한다. 일부만 바뀌었다면, 변화 없는 부분은 기존 참조를 유지하고 바뀐 부분만 교체한다.

- 단, structuralSharing은 queryFn이 [JSON으로 호환 가능한 data](251024.md)(= serialize 가능)를 반환할 때에만 유효하다.

  ```javascript
  // 최적화 작동
  useQuery("users", async () => {
    const res = await fetch("/api/users");
    return res.json(); // 순수 JSON 데이터
  });

  // 최적화 제한적 (함수, Date, Map, Set 등 ...)
  useQuery("users", async () => {
    const users = await fetchUsers();
    return users.map((user) => ({
      ...user,
      fullName: () => `${user.first} ${user.last}`, // 함수는 직렬화 불가
    }));
  });
  ```
