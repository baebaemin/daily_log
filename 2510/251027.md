## Today I Learned

### [TIL-WORDS]

- `intact`: 손대지 않은

## <br />

### [React Query] Structural Sharing

- 리액트 쿼리는 컴포넌트가 필요할 때만 리렌더링 되도록 여러 최적화 기법을 자동으로 적용한다. 그중 하나가 `Structural Sharing`으로, 데이터를 refetch해와도 참조값을 유지할 수 있도록 한다.

- 보통 네트워크로 데이터를 fetching할 때마다 JSON.parse()를 거치면서 완전히 새로운 객체가 생성된다.

  ```js
  // 서버에서 받은 JSON 문자열
  const jsonString = '{"id": 1, "name": "John"}';

  // JSON.parse()는 매번 새로운 객체를 생성
  const obj1 = JSON.parse(jsonString);
  const obj2 = JSON.parse(jsonString);

  // 위의 둘은 메모리상 완전히 다른 위치에 생성됨
  console.log(obj1 === obj2); // false
  ```

- 하지만 React Query는 데이터가 완전히 같으면 original 참조값을 유지한다. 일부만 바뀌었다면, 변화 없는 부분은 기존 참조를 유지하고 바뀐 부분만 교체한다.

- 단, `Structural Sharing`은 queryFn이 [JSON으로 호환 가능한 data](251024.md#javascript-json-호환-데이터)(= serialize 가능)를 반환할 때에만 유효하다.

  ```javascript
  // 최적화 작동
  useQuery("users", async () => {
    const res = await fetch("/api/users");
    return res.json(); // 순수 JSON 데이터
  });

  // 최적화 제한적 (함수, Date, Map, Set 등 ...)
  useQuery("users", async () => {
    const users = await fetchUsers();
    return users.map((user) => ({
      ...user,
      fullName: () => `${user.first} ${user.last}`, // 함수는 직렬화 불가
    }));
  });
  ```

- `Structural Sharing`은 기본적으로 활성화 되어있지만 필요에 따라 비활성화거나 커스터마이징 할 수 있다.

  - 데이터가 너무 크고 깊어서 성능에 영향을 줄 때
    - `Structural Sharing`은 전체 데이터 구조를 재귀적으로 순회하므로 오버헤드가 발생할 수 있다.
    - 참조 유지 이득(= 불필요한 리렌더링 방지 등)보다 비교 비용이 더 클 때에는 옵션을 끄는 것도 방법
  - 항상 새로운 참조가 필요한 특수 케이스
  - 커스텀 비교 로직이 필요할 때

  ```javascript
  // 전역 설정으로 비활성화
  const queryClientg = new QueryClient({
    defaultOptions: {
      queries: {
        structuralSharing: false, // 모든 쿼리에 대해 비활성화
      },
    },
  });

  // 특정 쿼리에서만 비활성화
  useQuery("users", fetchUsers, {
    structuralSharing: false, // 이 쿼리만 비활성화
  });

  // 커스텀 Structural Sharing 함수
  useQuery("users", fetchUsers, {
    structuralSharing: (oldData, newData) =>
      oldData?.version === newData?.version ? oldData : newData,
  });
  ```

- 참고 링크 1 : https://tanstack.com/query/latest/docs/framework/react/guides/render-optimizations#structural-sharing
- 참고 링크 2 : https://tkdodo.eu/blog/react-query-render-optimizations
- 소스 코드 : https://github.com/TanStack/query/blob/main/packages/query-core/src/utils.ts (이곳의 replaceEqualDeep 함수)
